# rabbitMQ 案例 (laravel)

## 官方 composer 配置

[English](https://www.rabbitmq.com/tutorials/tutorial-one-php.html)

[中文](https://learnku.com/articles/9117/rabbitmq-entry-work-queue)

## 创建连接工程

```php
use PhpAmqpLib\Connection\AMQPStreamConnection;
use PhpAmqpLib\Message\AMQPMessage;

// 创建连接 connection
$connection = new AMQPStreamConnection('localhost', 5672, 'guest', 'guest');
// 通过连接获取通道 Channel
$channel = $connection->channel();

/** 
 *  通过通道创建交换机，声明队列 'hello'
 *  @param 队列的名称
 *  @param 是否持久化(非持久化会存盘，但随着服务器的重启而丢失)
 *  @param 排他性，是否是一个独占队列
 *  @param 最后一个消息消费完毕是否自动删除队列
 *  @param 携带附属参数
 */
$channel->queue_declare('hello', false, false, false, false);
```

> 以下模式都可以使用 `php artisan make:command ` 创建响应类来模拟。

## Simple 模式

```php
// 准备消息内容
$msg = new AMQPMessage('Hello World!');
// 发送消息给队列
$channel->basic_publish($msg, '', 'hello');

// 关闭通道
$channel->close();
// 关闭连接
$connection->close();
```

```php
echo ' [*] Waiting for messages. To exit press CTRL+C', "\n";

$callback = function($msg) {
 echo " [x] Received ", $msg->body, "\n";
};

$channel->basic_consume('hello', '', false, true, false, false, $callback);

while(count($channel->callbacks)) {
   $channel->wait();
}
```