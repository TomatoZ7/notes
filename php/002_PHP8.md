# PHP 8 新特性

- [PHP 8 新特性](#php-8-新特性)
  - [1.PHP 8.0](#1php-80)
    - [1.1 即时编译](#11-即时编译)
    - [1.2 命名参数](#12-命名参数)
    - [1.3 注解](#13-注解)
    - [1.4 构造器属性提升](#14-构造器属性提升)
    - [1.5 联合类型](#15-联合类型)
    - [1.6 Match 表达式](#16-match-表达式)
    - [1.7 Nullsafe 运算符](#17-nullsafe-运算符)

## 1.PHP 8.0

### 1.1 即时编译

PHP 8 引入了两个即时编译引擎。Tracing JIT 在两个中更有潜力，它在综合基准测试中显示了三倍的性能，并在某些长时间运行的程序中显示了 1.5 - 2 倍的性能改进。

JIT 作为 PHP 底层编译引擎，对于 PHP8 的性能贡献非常之大，不过对于常规 WEB 应用来说，优势不明显，但仍然是非常高大上的特性，是 PHP8 的扛鼎之作。

### 1.2 命名参数

PHP7：

```php
htmlspecialchars($string, ENT_COMPAT | ENT_HTML401, 'UTF-8', false);
```

PHP8：

```php
htmlspecialchars($string, double_encode: false);
```

+ 仅仅指定必填参数，跳过可选参数。
+ **参数的顺序无关**、自己就是文档（self-documented）

### 1.3 注解

在 PHP7 中，注解的写法为：

```php
class PostsController
{
    /**
     * @Route("/api/posts/{id}", methods={"GET"})
     */
    public function get($id) { /* ... */ }
}
```

在 PHP8 中，注解写法优化为：

```php
class PostsController
{
    #[Route("/api/posts/{id}", methods: ["GET"])]
    public function get($id) { /* ... */ }
}
```

现在可以用 PHP 原生语法来使用结构化的元数据，而非 PHPDoc 声明。

### 1.4 构造器属性提升

在PHP7中，构造器的写法为：

```php
class Point {
    public float $x;
    public float $y;
    public float $z;

    public function __construct(
        float $x = 0.0,
        float $y = 0.0,
        float $z = 0.0
    ) {
        $this->x = $x;
        $this->y = $y;
        $this->z = $z;
    }
}
```

在 PHP8 中，构造器的写法优化为：

```php
class Point {
    public function __construct(
        public float $x = 0.0,
        public float $y = 0.0,
        public float $z = 0.0,
    ) {}
}
```

现在可以用更少的样板代码来定义并初始化属性。

### 1.5 联合类型

在 PHP7 中，联合类型的写法为：

```php
class Number {
    /** @var int|float */
    private $number;

    /**
     * @param float|int $number
     */
    public function __construct($number) {
        $this->number = $number;
    }
}
new Number('NaN'); // Ok
```

在PHP8中，联合类型的写法优化为：

```php
class Number {
    public function __construct(
        private int|float $number
    ) {}
}
new Number('NaN'); // TypeError
```

相较于以前的 PHPDoc 声明类型的组合， 现在可以用原生支持的联合类型声明取而代之，并在运行时得到校验。

### 1.6 Match 表达式

在 PHP7 中，match 表达式的写法为：

```php
switch (8.0) {
    case '8.0':
        $result = "Oh no!";
        break;
    case 8.0:
        $result = "This is what I expected";
        break;
}

echo $result;
//> Oh no!
```

在 PHP8 中，match 表达式的写法优化为：

```php
echo match (8.0) {
  '8.0' => "Oh no!",
  8.0 => "This is what I expected",
};
//> This is what I expected
```

新的 match 类似于 switch，并具有以下功能：

+ Match 是一个表达式，它可以储存到变量中亦可以直接返回。
+ Match 分支仅支持单行，它不需要一个 `break;` 语句。
+ Match 使用严格比较。

### 1.7 Nullsafe 运算符

在 PHP7 中，`nullsafe` 运算符的写法为：

```php
$country =  null;
if ($session !== null) {
    $user = $session->user;
    if ($user !== null) {
        $address = $user->getAddress();
    
        if ($address !== null) {
            $country = $address->country;
        }
    }
}
```

在 PHP8 中，Nullsafe 运算符的写法优化为：

```php
$country = $session?->user?->getAddress()?->country;
```

现在可以用新的 nullsafe 运算符链式调用，而不需要条件检查 null。如果链条中的一个元素失败了，整个链条会中止并认定为 null。

