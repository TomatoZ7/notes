# PHP 内存(垃圾)回收机制

## 概念
垃圾回收机制是一种动态存储分配的方案。它会自动释放程序不再需要的已分配的内存块。垃圾回收机制可以让程序员不必过分关心程序内存分配，从而将更多的精力投入到业务逻辑。在现在的流行各种语言当中，垃圾回收机制是新一代语言所共有的特征，如 Python、PHP、C#、Ruby 等都使用了垃圾回收机制。

## PHP5.3 之前的"垃圾回收"
只有 php5.3 版本以后的才有了所谓的新的垃圾回收机制 GC。

在 PHP5.3 版本之前,使用的垃圾回收机制是单纯的“引用计数”。

> 引用计数  
> 官方手册介绍 php 的每个变量都是存在一个叫做 zval 的容器里面，这个容器不仅包含了这个变量的值和类型，还包含了另外两个重要的信息，"is_ref" 和 "refcount"。"is_ref" 看名字就应该知道大概和引用相关，它是一个 bool 值，如果这个值是 true 那么代表这是一个引用变量，否则是普通变量。"refcount" 指的是有多少个变量（符号）指向这个 zval 容器。

即：
1. 每个内存对象都分配一个计数器，当内存对象被变量引用时，计数器+1；
2. 当变量引用撤掉后（执行 `unset()` 后），计数器-1；
3. 当计数器=0时，表明内存对象没有被使用，该内存对象则进行销毁，垃圾回收完成。

并且 PHP 在一个生命周期结束后就会释放此进程/线程所占的内容，这种方式决定了 PHP 在前期不需要过多考虑内存的泄露问题。

但是当两个或多个对象互相引用形成环状后，内存对象的计数器则不会消减为0；这时候，这一组内存对象已经没用了，但是不能回收，从而导致内存泄露的现象。

php5.3开始，使用了新的垃圾回收机制，在引用计数基础上，实现了一种复杂的算法，来检测内存对象中引用环的存在，以避免内存泄露。