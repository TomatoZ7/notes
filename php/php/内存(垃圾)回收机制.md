# PHP 内存(垃圾)回收机制

## 概念
垃圾回收机制是一种动态存储分配的方案。它会自动释放程序不再需要的已分配的内存块。垃圾回收机制可以让程序员不必过分关心程序内存分配，从而将更多的精力投入到业务逻辑。在现在的流行各种语言当中，垃圾回收机制是新一代语言所共有的特征，如 Python、PHP、C#、Ruby 等都使用了垃圾回收机制。

## 如何定义垃圾

主要看有没有变量指向变量容器 zval，如果没有则认为是垃圾，需要释放。

## PHP5.3 之前的"垃圾回收"(不包括 5.3)
只有 php5.3 版本以后的才有了所谓的新的垃圾回收机制 GC。

在 PHP5.3 版本之前,使用的垃圾回收机制是单纯的[引用计数](https://github.com/TomatoZ7/notes-of-tz/blob/master/php/php/php%E5%BC%95%E7%94%A8%E8%AE%A1%E6%95%B0.md)。

即：
1. 每个内存对象都分配一个计数器，当内存对象被变量引用时，计数器+1；
2. 当变量引用撤掉后（执行 `unset()` 后），计数器-1；
3. 当计数器=0时，表明内存对象没有被使用，该内存对象则进行销毁，垃圾回收完成。

并且 PHP 在一个生命周期结束后就会释放此进程/线程所占的内容，这种方式决定了 PHP 在前期不需要过多考虑内存的泄露问题。

但是当两个或多个对象互相引用形成环状后，内存对象的计数器则不会消减为0；这时候，这一组内存对象已经没用了，但是不能回收，从而导致内存泄露的现象。

php5.3开始，使用了新的垃圾回收机制，在引用计数基础上，实现了一种复杂的算法，来检测内存对象中引用环的存在，以避免内存泄露。

## PHP5.3 之后的 GC

先说说 GC 的三个基本规则：

1. 如果一个 zval 容器的 `refcount` 增加，说明有新的变量(符号)指向这个容器，那么这个容器不会是垃圾，将被继续使用。

2. 如果一个 zval 容器的 `refcount` 减少到 0，说明没有变量(符号)指向这个容器，他就会被 php 引擎销毁。

3. 如果一个 zval 容器的 `refcount` 减少了，但是大于 0，那么这个容器就有可能是垃圾，就会被垃圾回收机制所管理。

就是对 zval 容器中的每个元素进行一次 `refcount-1` 操作，操作完成之后，如果 zval 的 `refcount` 为 0，那么这个 zval 就是一个垃圾。

引用官方手册：

![image](https://github.com/TomatoZ7/notes-of-tz/blob/master/images/php_gc1.jpg)

A. 为了避免每次变量的 refcount 减少的时候都调用 GC 算法，此算法会将所有前面准则 3 情况下的 zval 容器放入一个容器缓冲区(root buffer)中，并且将这些 zval 容器标记为紫色，同时算法必须确保每一个 zval 容器在缓冲区里只出现一次。当缓冲区被容器塞满时，GC 才开始对缓冲区中的 zval 容器进行垃圾判断。

B. GC 算法以深度优先对每一个容器所包含的 zval 进行减 1 操作，为了确保不会对同一 zval 进行重复操作，每当 zval 减一的时候会被标记为灰色。需要强调的是，起初容器 zval 本身并不会作减一操作，但是如果容器 zval 中包含的 zval 又指向了容器 zval，那么这个时候需要对容器 zval 进行减一操作。

C. 算法再度以深度优先判断每一个 zval 容器的值，如果 zval 的 `refcount` 为 0，则标记为白色(代表垃圾)，如果 zval 的 `refcount` 大于 0，那么将对此 zval 以及其包含的 zval 进行 refcount 加一操作，这个是对非垃圾的还原操作，同时将这些 zval 变成黑色(zval 默认颜色)。

D. 遍历 zval 容器，把 C 中标记为白色的释放掉。

## GC 的配置

### 开启/关闭 GC

在 php.ini 中设置来开启/关闭(On/Off) GC：

```php.ini
zend.enable_gc = On
```

也能通过分别调用 `gc_enable()` 和 `gc_disable()` 函数在运行 php 时来打开和关闭垃圾回收机制。

`gc_collect_cycles()` : 在节点缓冲区未满的情况下强制执行垃圾分析算法。

### 根缓存区

根缓存区有固定的大小，默认 10000，可以通过修改PHP源码文件 Zend/zend_gc.c 中的常量 GC_ROOT_BUFFER_MAX_ENTRIES，然后重新编译 PHP，来修改这个值。

## 传送门

[一看就懂系列之 由浅入深聊一聊php的垃圾回收机制](https://blog.csdn.net/u011957758/article/details/76864400)

[php内存回收机制的学习](https://www.cnblogs.com/impy/p/7850955.html)

[面试经常问你什么是PHP垃圾回收机制？](https://zhuanlan.zhihu.com/p/130986001)
