# 聚合

## 1 聚合框架

使用聚合框架可以对集合中的文档进行变换和组合。可以用多个构建一个管道 (pipeline)，用于对一连串的文档进行处理。这些构件包括筛选(filtering)、投射(projecting)、分组(grouping)、排序(sorting)、限制(limiting) 和 跳过(skipping)。

例如，有一个保存着杂志文章的集合，你可能希望找出发表文章最多的那个作者。假设每篇文章被保存为 `MongoDB` 中的一个文档，可以按照如下步骤创建管道。

1. 将每个文章文档中的作者投射出来。

2. 将作者按照名字排序，统计每个名字出现的次数。

3. 将作者按照名字出现次数降序排列。

4. 将返回结果限制为 5 个。

这里面的每一步都对应局和框架中的一个操作符：

1. `{"$project": {"author": 1}}`

这样可以将 `author` 从每个文档中投射出来。

2. `{"$group": {"_id": "$author", "count": {"$sum": 1}}`

这样就会将作者按照名字排序，某个作者的名字每出现一次，就会对这个作者的 `count` 加 1。

这里首先指定了需要进行分组的字段 `author`。这是由 `"_id": "$author"` 指定的。可以将这个操作想象为：这个操作执行完后，每个作者只对应一个结果文档，所以 `author` 就成了文档的唯一标识符 `_id`。

第二个字段的意思是为分组内每个文档的 `count` 字段加 1。注意，新加入的文档中并不会有 `count` 字段，这是 `$group` 创建的一个新字段。

3. `{"$sort": {"count": -1}}`

这个操作会对结果集中的文档根据 `count` 字段进行降序排列。

4. `{"$limit": 5}`

这个操作将最终的返回结果限制为当前结果中的前 5 个文档。

在 `MongoDB` 中实际运行时，要将这些操作分别传给 `aggregate()` 函数：

```js
> db.articles.aggregate({"$project": {"author": 1}},
... {"$group": {"_id": "$author", "count": {"$sum": 1}}},
... {"$sort": {"count": -1}},
... {"$limit": 5})
{
    "result" : [
        {
            "_id" : "R. L. Stine",                
            "count" : 430
        },
        {
            "_id" : "Edgar Wallace",
            "count" : 175
        },
        {
            "_id" : "Nora Roberts",
            "count" : 145
        },
        {
            "_id" : "Erle Stanley Gardner",
            "count" : 140
        },
        {
            "_id" : "Agatha Christie",
            "count" : 85
        }
    ],
    "ok" : 1
}
```

`aggregate()` 会返回一个文档数组，其中的内容是发表文章最多的 5 个作者。

如果管道没有给出预期的结果，就需要进行调试，调试时，可以逐个指定管道操作符，一步步推导出预期结果。

聚合的结果输出给客户端时必须要限制在 16 MB 以内(`MongoDB` 支持的最大响应消息大小)。

## 2 管道操作符

每个操作符都会接受一连串的文档，对这些文档做一些类型转换，最后转换后的文档作为结果传递给下一个操作符，最后一个操作符返回给客户端。

不同的管道操作符可以按任意顺序组合在一起使用，而且可以被重复任意多次。例如，可以先做 `$match`，然后 `$group`，然后再做 `$match`。