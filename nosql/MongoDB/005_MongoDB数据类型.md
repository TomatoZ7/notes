# MongoDB 数据类型

## 1 基本数据类型

在概念上 `MongoDB` 的文档与 `JavaScript` 中的对象想进，因而可认为它类似于 `JSON`。(`JSON` 只有 `null`、布尔、数字、字符串、数组和对象 6 中数据类型)

`MongoDB` 在保留 `JSON` 基本键值对特性的基础上，添加了其他一些数据类型。

### 1.1 null

`null` 用于表示空值或者不存在的字段：

```js
{"x": null}
```

### 1.2 布尔型

`{"x": true}`

### 1.3 数值

`shell` 默认使用 64 位浮点型数值。

```js
{"x": 3.14} 
或
{"x": 3}
```

对于整型，可使用 `NumberInt` 类(表示 4 字节带符号整数)或 `NumberLong` 类(表示 8 字节带符号整数)，分别举例如下：

```js
{"x": NumberInt("3")}
{"x": NumberLong("3")}
```

### 1.4 字符串

`{"x": "abc"}`

### 1.5 日期

日期被存储为自新纪元以来经过的毫秒数，不存储时区：

```js
{"x": new Date()}
```

### 1.6 正则表达式

查询时，使用正则表达式作为限定条件，语法也与 `JavaScript` 的正则语法相同：

```js
{"x": /foobar/i}
```

### 1.7 数组

`{"x": ["a", "b", "c"]}`

### 1.8 内嵌文档

文档可嵌套其他文档，被嵌套的文档作为父文档的值：

```js
{"x": {"foo": "bar"}}
```

同数据一样，`MongoDB` 能够理解内嵌文档的结构，并能深入其中构建索引、执行查询或者更新。

### 1.9 对象 id

`MongoDB` 中存储的文档必须有一个 `_id` 键，是文档的唯一标识。这个键的值可以是任何类型，默认是个 `ObjectId` 对象。

```js
{"x": ObjectId()}
```

`ObjectId` 使用 12 字节的存储空间，是一个由 24 个十六进制数字组成的字符串。

如果快速连续创建多个 `ObjectId`，会发现每次只有最后几位数字有变化。另外，中间的几位数字也会变化(要是在创建的过程中停顿几秒钟)。这是 `ObjectId` 的创建方式导致的。`ObjectId` 的 12 字节按照如下方式生成：

![image](https://github.com/TomatoZ7/notes-of-tz/blob/master/nosql/MongoDB/images/mongo_data_type_1.jpg)

`ObjectId` 的前 4 个字节是从标准纪元开始的时间戳，单位为秒。这会带来一些有用的属性：

+ 时间戳与随后的 5 字节组合起来，提供了秒级别的唯一性。

+ 由于时间戳在前，这意味着 `ObjectId` 大致会按照插入的顺序排列。这对于某些方面很有用，比如可以将其作为索引提高效率，但是这个是没有保证的，仅仅是"大致"。

+ 这 4 字节也隐含了文档创建的事件。绝大多数驱动程序都会提供一个方法，用于从 `ObjectId` 获取这些信息。

接下来 3 字节是所在主机的唯一标识符。通常是机器主机名的散列值(hash)。这样就可以确保不同主机生成不同的 `ObjectId`，不产生冲突。

为了确保在同一台机器上并发的多个进程产生的 `ObjectId` 是唯一的，接下来的 2 字节来自产生 `ObjectId` 的进程的进程标识符(PID)。

前 9 字节保证了同一秒钟不同机器不同进程产生的 `ObjectId` 是唯一的。最后 3 字节是一个自动增加的计数器，确保相同进程同一秒产生的 `ObjectId` 也是不一样的。一秒钟最多允许每个进程 256^3(16777216) 不同的 `ObjectId`。

#### 1.9.1 自动生成 _id

如果插入文档时没有 `_id` 键，系统会自动帮你创建一个。可以由 `MongoDB` 服务器来做这件事，但通常会在客户端由驱动程序完成。这一做法非常好地体现了 `MongoDB` 的哲学：能交给客户端驱动程序来做的事情就不要交给服务器来做。

这种理念背后的原因是，即便是像 `MongoDB` 这样扩展性非常好的数据库，扩展应用层也要比扩展数据库层容易得多。将工作交由客户端来处理，就减轻了数据库扩展的负担。

### 1.10 二进制数据

二进制数据是一个任意字节的字符串。它不能直接在 `shell` 中使用。如果要将非 `UTF-8` 字符保存到数据库中，二进制数据是唯一的方式。

### 1.11 代码

查询和文档中可以包含任意 `JavaScript` 代码：

```js
{"x": function() { /* ... */ }}
```