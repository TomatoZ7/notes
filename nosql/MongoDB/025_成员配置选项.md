# 成员配置选项

有时候我们希望让某个成员拥有优先成为主节点的权利，或者是让某个成员对客户端不可见，这样便不会有读写请求发送给它。在副本集配置的子文档中可以为每个成员指定这些选项。

## 1 选举仲裁者

现实开发中很多应用程序使用量较小，并不想保存第三份数据副本，节约成本。

对于这种部署，`MongoDB` 支持一种特殊类型的成员，成为**仲裁者(arbiter)**。仲裁者的唯一作用就是参与选举。仲裁者并不保存数据，也不会为客户端提供服务：它只是为了帮助具有两个成员的副本集能够满足"大多数"这个条件。

由于仲裁者并不需要履行传统 `mongod` 服务器的责任，所以可以将仲裁者作为轻量级进程，运行在配置比较差的服务器上。如果可能，应该将仲裁者放在单独的**故障域(failure domain)**中，与其他成员分开。

启动仲裁者与启动普通的 `mongod` 的方式相同，可以使用 `rs.addArb()` 辅助函数将仲裁者添加到副本集中：

```shell
$ rs.addArb("server:27017")
```

也可以在成员配置中指定 `arbiterOnly` 选项，这与上面的效果是一样的：

```shell
$ rs.add({"_id": 4, "host": "server:27017", "arbiterOnly": true})
```

成员一旦以仲裁者的身份添加到副本集中，它就永远只能是仲裁者：无法将仲裁者重新配置为非仲裁者，反之亦然。

使用仲裁者的另一个好处是，如果你拥有的节点数是偶数，那么可能会出现两个节点获得投票数相等的情况，仲裁者这时就可以投出决定胜负的一票。

### 1.1 最多只能使用一个仲裁者

注意，在上面的例子中，仲裁者只需要一个。如果节点数是奇数，那就不需要仲裁者。

假设有一个包含 3 个成员的副本集。需要 2 个成员才能组成"大多数"，才能选举主节点。如果这时添加了一个仲裁者，副本集中总有就有 4 个成员了，要有 3 个成员才能组成"大多数"。因此，副本集的**稳定性**其实是**降低**了：原本只需要 67% 的成员可用，副本集就可用，现在必须要有 75% 的成员可用，副本集才可用。

添加额外成员也会导致选举耗时变长，也会导致两个成员票数相同的情况，仲裁者的目的应该是**避免出现平票**，而不是导致出现平票。

### 1.2 仲裁者的缺点

不知道应该将一个成员作为数据节点还是作为仲裁者时，应该将其作为数据节点。**在小副本集中使用仲裁者而不是数据节点会导致一些操作性任务变困难。**

假设有一个副本集，它有 2 个数据节点和 1 个仲裁者。这时如果主节点挂了，那么另一个节点成为主节点。这时整个副本集只有 1 个数据节点和 1 个仲裁者。为了保证数据安全，就需要新增一个备份节点，并且将主节点的数据副本复制到备份节点。复制数据会对服务器造成很大压力，会拖慢应用程序。

相反，如果拥有 3 个数据成员，一个服务器挂掉时，还有一主一备份，不会影响正常运作。这时，可以用剩余的那个备份节点来初始化一个新的备份节点服务器，而不必依赖主节点。

**如果可能，尽可能在副本集中使用奇数个数据成员，而不要使用仲裁者。**

## 2 优先级

优先级用于表示一个成员成为主节点的优先程度。默认 1，取值 0~100.

将优先级设为 0 代表该成员永远不能够成为主节点。这样的成员称为**被动成员(passive member)**。

在副本中添加优先级为 1.5 的成员：

```shell
$ rs.add({"_id": 5, "host": "iZuf61wwjib0gi7cyckz02Z:28017", "priority": 1.5})
```

假设其他成员的优先级都是 1，同时 28017 端口的 `mongod` 服务拥有最新的数据，那么当前的主节点就会自动退位，新增节点被选举为新的主节点。如果数据不够新，那么主节点不变。

设置优先级并不会导致副本集选不出主节点，也不会使数据不够新的成员成为主节点(一直到它的数据更新到最新)。

使用优先级时有一点需要注意：修改副本集配置时，新的配置必须要发送给在新配置下可能成为主节点的成员。因此，无法在一次 `reconfig` 操作中将当前主节点的优先级设置为 0，也不能对所有成员优先级都为 0 的副本集执行 `reconfig`。

## 3 隐藏成员

客户端不会向隐藏成员发送请求，隐藏成员也不会作为复制源（尽管当其他复制源不可用时隐藏成员也会被使用）。因此，很多人会将不够强大的服务器或者备份服务器隐藏起来。

假设有一副本集如下所示：

```shell
$ rs.isMaster()
{
    ...
    "hosts" : [
        "server-1:27107",
        "server-2:27017",
        "server-3:27017"
    ],
    ...
}
```

为了隐藏 `server-3`，可以在它的配置中指定 `hidden:true`。**只有优先级为 0 的成员才能被隐藏(不能将主节点隐藏)**：

```shell
$ var config = rs.config()
$ config.members[2].hidden = 0
0
$ config.members[2].priority = 0
0
$ rs.reconfig(config)
```

现在，执行 `isMaster()` 可以看到：

```shell
$ rs.isMaster()
{
    ...
    "hosts" : [
        "server-1:27107",
        "server-2:27017"
    ],
    ...
}
```

使用 `rs.status()` 和 `rs.config()` 可以看到隐藏成员。隐藏成员只对 `isMaster()` 不可见，因为客户端连接到副本集时，会调用 `isMaster()` 来查看可用成员。因此，隐藏成员不会受到客户端的读请求。

要将隐藏成员设为非隐藏，只需将配置中的 `hidden` 设为 `false` 或者删除该选项即可。

## 4 创建索引

有时，备份节点并不需要与主节点拥有相同的索引，**甚至可以没有索引**。

如果某个备份节点的用途仅仅是处理数据备份或者是离线的批量任务，那么你可能希望在它的成员配置中指定 `"buildIndexes" :false`。这个选项可以阻止备份节点创建索引。

指定了 `"buildIndexes" : false` 的成员永远无法恢复为可以创建索引的普通成员。如果确实需要将不创建索引的成员修改为可以创建索引的成员，那么必须将这个成员从副本集中移除，再删除它的所有数据，最后再将它重新添加到副本集中，并且允许它重新进行数据同步。

另外，这个选项要求成员的优先级为 0。