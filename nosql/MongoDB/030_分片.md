# 分片

## 1 简介

**分片（sharding）是指将数据拆分，将其分散存放在不同的机器上的过程。**有时也用**分区（partitioning）**来表示这个概念。将数据分散到不同的机器上，不需要功能强大的大型计算机就可以储存更多的数据，处理更大的负载。

**几乎所有数据库软件都能进行手动分片（manual sharding）。**应用需要维护与若干不同数据库服务器的连接，每个连接还是完全独立的。应用程序管理不同服务器上不同数据的存储，还管理在合适的数据库上查询数据的工作。这种方法可以很好地工作，但是非常难以维护，比如向集群添加节点或从集群删除节点都很困难，调整数据分布和负载模式也不轻松。

`MongoDB` 支持**自动分片（autosharding）**，可以使数据库架构对应用程序不可见，也可以简化系统管理。对应用程序而言，好像始终在一个单机的 `MongoDB` 服务器一样。另一方面，`MongoDB` 自动处理数据再分片上的分布，也更容易添加和删除分片。不管从开发角度还是运营角度来说，分片都是最困难最复杂的 `MongoDB` 配置方式。

## 2 集群的组件

`MongoDB` 的分片机制允许你创建一个包含许多台机器（分片）的集群，将数据子集分散在集群中，每个分片维护着一个数据集合的子集。与单机服务器和副本集相比，使用集群架构可以使应用程序具有更大的数据处理能力。

> 分片和复制的区别：复制是让多台服务器都拥有同样的数据副本，每一台服务器都是其他服务器的镜像，而每一个分片都拥有其他分片拥有的不同数据子集。

整个集群对应用程序来说就像是一台单机服务器，为了对应用程序隐藏数据库架构的细节，在分片之前要先执行 `mongos` 进行一次路由过程。这个路由服务器维护着一个**内容列表**，指明了每个分片包含什么数据内容。应用程序只需要连接到路由服务器，就可以像使用单机服务器一样进行正常的请求了，如图所示。

![image](https://github.com/TomatoZ7/notes-of-tz/blob/master/nosql/MongoDB/images/mongo_slice_1.jpg)

路由服务器知道哪些数据位于哪个分片，可以将请求转发给相应的分片。

每个分片对请求的响应都会发送给路由服务器，路由服务器将所有响应合并在一起，返回给应用程序。对应用程序来说，它只知道自己是连接到了一台单机 `mongod` 服务器，如图所示。

![image](https://github.com/TomatoZ7/notes-of-tz/blob/master/nosql/MongoDB/images/mongo_slice_2.jpg)