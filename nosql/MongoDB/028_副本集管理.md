# 副本集管理

副本集配置总是以一个文档的形式保存在 `local.system.replSet` 集合中。副本集中所有成员的这个文档都是相同的。绝对不要使用 `update` 更新这个文档，应该使用 `rs` 辅助函数或者 `replSetReconfig` 命令修改副本集配置。

## 1 创建比较大的副本集

副本集最多只能拥有 12 个成员，其中只有 7 个成员拥有投票权。这是为了减少心跳请求的网络流量（每个成员都要向其他所有成员发送心跳请求）和选举花费的时间。

如果要创建 7 个以上成员的副本集，只有 7 个成员可以拥有投票权，需要将其他成员的投票数量设置为 0：

```shell
$ rs.add({"_id": 7, "host": "server-7:27017", "votes": 0})
```

这样可以阻止这些成员在选举中投主动票，虽然它们仍然可以投否决票。

**应该尽量避免修改成员的投票数量。**投票可能会对选举和一致性产生怪异的、不直观的影响。应该只在创建包含 7 个以上成员的副本集或者是希望阻止自动故障转移<!-- 12.5.2 -->时，使用 `votes` 选项。

## 2 强制重新配置

如果副本集无法再达到“大多数”要求的话，那么它就无法选举出新的主节点，这时你可能会希望重新配置副本集。这看起来有点奇怪，因为通常都是将配置文件发送给主节点。在这种情况下，可以在备份节点上调用 `rs.reconfig` **强制重新配置（force reconfigure）**副本集。在 `shell` 中连接到一个备份节点，使用 `force` 选项执行 `rs.reconfig` 命令：

```shell
rs.reconfig(config, {"force": true})
```

强制重新配置与普通的重新配置要遵守同样的规则：必须使用正确的 `reconfig` 选项将有效的、格式完好的配置文件发送给成员。`force` 选项不允许无效的配置，而且只允许将配置发送给备份节点。

强制重新配置会跳过大量的数值直接将副本集的 `version` 设为一个比较大的值。可能会见到跳过数千的情况，这很正常：这是为了防止 `version` 字段冲突（以防不同的网络域中都在进行重新配置）。

备份节点收到新的配置文件之后，就会修改自身的配置，并且将新的配置发送给副本集中的其他成员。副本集的其他成员收到新的配置文件之后，会判断配置文件的发送者是否是它们当前配置中的一员，如果是，才会用新的配置文件对自己进行重新配置。

所以，如果新的配置会修改某些成员的主机名，应该将新的配置发送给主机名不发生变化的成员。

如果新的配置文件修改了所有成员的主机名，应该关闭副本集的每一个成员，以单机模式启动，手动修改 `local.system.replset` 文档，然后重新启动。

## 3 修改成员状态

为进行维护和响应加载，有多种方式可以手动修改成员的状态。注意，**无法强制将某个成员变成主节点**，除非对副本集做适当的配置。

### 3.1 把主节点变为备份节点

可以使用 `stepDown` 函数将主节点降级为备份节点：

```shell
$ rs.stepDown()
```

### 3.2 组织选举

如果需要对主节点做一些维护，但是**不希望这段时间内将其他成员选举为主节点**，可以在每个备份节点执行 `freeze` 命令，以强制它们始终处于备份节点状态：

```shell
$ rs.freeze(10000)
```