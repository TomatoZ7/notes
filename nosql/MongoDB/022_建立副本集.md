# 建立副本集

使用 `MongoDB` 的复制功能可以将数据副本保存到多台服务器上，即使一台服务器出错，也可以保证应用程序正常运行和数据安全。

在 `MongoDB` 中，创建一个副本集之后就可以使用复制功能了。副本集是一组服务器，其中有一个**主服务器(primary)**，用于处理客户端请求；还有多个**备份服务器(secondary)**，用于保存主服务器的数据副本。如果主服务器崩溃了，备份服务器会自动将其中一个成员升级为新的主服务器。

接下来我们尝试在 `centos 7` 服务器上建立一个**包含三个成员的副本集**。

## 1 创建数据目录

`MongoDB` 启动时将使用一个数据目录存放所有的数据文件。我们将 3 个复制集节点创建各自的数据目录。

```shell
$ mkdir -p /data/db{1,2,3}
```

## 2 准备配置文件

复制集的每个 `mongod` 进程应该位于不同的服务器。我们现在在一台机器上运行 3 个进程，因此要为它们各自配置：

+ 不同的端口。将使用 28017/28018/28019

+ 不同的数据目录。将使用 `/data/db{1,2,3}`

+ 不同的日志文件路径。将使用 `/data/db{1,2,3}/mongod.log`

配置文件 `mongod.conf`：

```conf
systemLog:
    destination: file
    path: /data/db1/mongod.log    # log path
    logAppend: true
storage:
    dbPath: /data/db1    # data directory
net:
    bindIp: 0.0.0.0
    port: 28017
replication:
    replSetName: rs0
processManagement:
    fork: true  # 作为独立的后台进程
```

> 配置文件需遵循 `YAML` 格式，不可以使用 TAB 键，冒号 `:` 后面需跟上一个空格。

将三份配置文件放至三个 `db` 目录下，注意 `systemLog.path`、`storage.dbPath` 和 `net.port` 需要根据目录进行调整。

## 3 启动 mongod 进程

```shell
$ mongod -f /data/db1/mongod.conf
about to fork child process, waiting until server is ready for connections.
forked process: 20263
child process started successfully, parent exiting

$ mongod -f /data/db2/mongod.conf
$ mongod -f /data/db3/mongod.conf

# 查看 mongod 进程
$ ps -ef|grep mongo
root     17540     1  1 14:28 ?        00:00:23 mongod -f db1/mongod.conf
root     18364     1  1 14:35 ?        00:00:17 mongod -f db2/mongod.conf
root     20263     1  1 14:52 ?        00:00:04 mongod -f db3/mongod.conf
root     20829 26315  0 14:57 pts/0    00:00:00 grep --color=auto mongod
```

## 4 配置复制集

现在已经有 3 个 `mongod` 实例，但它们现在是各自独立的，互不相干的，所以我们现在需要将它们组合起来。

进入 `mongo`：

```shell
$ mongo --port 28017
```

### 4.1 方法 1

```shell
> rs.initiate()

rs0.SECONDARY>      # 回车，PRIMARY 和 SECONDARY 是当前成员的状态，rs0 是副本集的标识符
rs0.PRIMARY>

# 查看节点信息
rs0.PRIMARY> rs.status()
rs0.PRIMARY> rs.isMaster()  # ismaster 是否主节点 hosts 节点列表 primary 主节点标识符

rs0.PRIMARY> rs.add("iZuf61wwjib0gi7cyckz02Z:28018")
rs0.PRIMARY> rs.add("iZuf61wwjib0gi7cyckz02Z:28019")
```

### 4.2 方法 2

```shell
$ rs.initiate({
    _id: "rs0",
    members: [{
        _id: 0,
        host: "localhost:28017"
    },{
        _id: 1,
        host: "localhost:28018"
    },{
        _id: 2,
        host: "localhost:28019"
    }]
})
```

# 5 验证

```shell
> 
```