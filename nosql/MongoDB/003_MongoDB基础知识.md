# MongoDB 基础知识

## 1 文档

**文档**是 `MongoDB` 的核心概念。文档就是键值对的有序集。每种编程语言表示文档的方法不太一样，但大多数编程语言都有一些相通的数据结构，比如映射(map)、散列(hash)或字典(dictionary)。例如，在 `Javascript` 里面，文档被表示为对象：

```js
{"greeting": "Hello World!"}
```

这个文档只有一个键值对，大多数文档都包含多个键值对。

### 1.1 值

文档的值可以是多种不同的数据类型，也可以是一个内嵌的文档。

### 1.2 键

文档的键是字符串，除了少数特例，键可以使用任意 `UTF-8` 字符。

+ 键不能含有 `\0`(空字符)，这个字符用于表示键的结尾。

+ `.` 和 `$` 具有特殊意义，只能在特定环境下使用。通常，这两个字符是被保留的，如果使用不当，驱动程序会有提示。

### 1.3 大小写

`MongoDB` 区分类型和大小写。下面两个文档是不同的：

```js
{"foo": 3}
{"foo": "3"}
```

下面两个文档也是不同的：

```js
{"foo": 3}
{"Foo": 3}
```

### 1.4 不能有重复的键

下面的文档是非法的：

```js
{
    "greeting": "Hello World!",
    "greeting": "Hello MongoDB!"
}
```

### 1.5 字段的顺序

文档中的键值对是有序的，如 `{"x": 1, "y": 2}` 和 `{"y":2, "x":1}` 是不同的。通常来说字段顺序并不重要，`MongoDB` 也会对字段进行重新排序，我们只需注意特殊情况下需要字段排序的场景。

## 2 集合

集合就是一组文档，类似于关系型数据库数据表的概念。

### 2.1 动态模式

集合是动态模式的。这意味着一个集合里面的文档可以是各式各样的。例如下面两个文档可以存放在同一个集合里面：

```js
{"greeting": "Hello World!"}
{"foo": 5}
```

既然一个集合可以存放各种不同的文档，那为什么我们还要使用多个集合呢？这个因为

+ 每个集合存放格式统一的文档，方便查询，减少判断和筛选。

+ 在一个集合里查询特定类型的文档比在不同集合里查询同一个类型的文档效率要低。例如，文档里有一个 `type` 键用于指定文档是 `skim`、`whole` 还是 `chunky money`，从一个集合里查询这三种类型的文档，速度会很慢；但是如果将这三种不同类型的文档拆分为三个不同的集合，每次只需要查询相对应的集合，速度快很多。

+ 把同种类型的文档放到一个集合里，数据会更加集中。分别从一个只包含文章的集合里和一个既包含文章又包含作者信息的集合里取出几条文章记录，相比之下前者所需的磁盘寻道操作更少。

+ 创建索引(特别是唯一索引)时，需要使用文档的附加结构。索引是按照集合来定义的，在一个集合中只存放一种类型的文档，可以更有效地对集合进行索引。

### 2.2 命名

集合的命名使用 `UTF-8` 字符串，需注意：

+ 不能是空字符串。

+ 集合名不能包含 `\0` 字符(空字符)，这个字符表示命名结束。

+ 集合名不能以 `system.` 开头，这是为系统集合保留的前缀。例如，`system.users` 这个集合保存数据库的用户信息，而 `system.namespaces` 集合保存所有数据库集合的信息。

+ 用户创建的集合名不能包含 `$`，因为某些系统生成的集合包含 `$`。

### 2.3 子集和

组织集合的一种惯例是使用 `.` 分隔不同命名空间的子集合。例如，一个具有博客功能的应用可能包含两个集合，分别是 `blog.posts` 和 `blog.authors`。这是为了使组织结构更清晰，这里的blog集合（这个集合甚至不需要存在）跟它的子集合没有任何关系。

虽然子集合没有任何特别的属性，但它们却非常有用，因而很多MongoDB工具都使用了子集合。

+ `GridFS`（一种用于存储大文件的协议）使用子集合来存储文件的元数据，这样就可以与文件内容块很好地隔离开来。

+ 大多数驱动程序都提供了一些语法糖，用于访问指定集合的子集合。例如，在数据库 `shell` 中，`db.blog` 代表 `blog` 集合，而 `db.blog.posts` 代表 `blog.posts` 集合。

在 `MongoDB` 中，使用子集合来组织数据非常高效，值得推荐。

## 3 数据库

在 `MongoDB` 中，多个文档组成集合，而多个集合可以组成数据库。一个 `MongoDB` 实例可以承载多个数据库，每个数据库拥有 0 个或者多个集合。每个数据库都有独立的权限，即便是在磁盘上，不同的数据库也放置在不同的文件中。

### 3.1 命名

数据库名使用 `UTF-8` 字符串，满足以下条件：

+ 不能是空字符串。

+ 不能含有 `/`、`\`、`.`、`"`、`*`、`<`、`>`、`:`、`|`、`?`、`$`、空格、`\0`(空字符)。基本上只能使用 `ASCII` 中的字母和数字。

+ 数据库名区分大小写，简单起见，建议全部小写。

+ 数据库名最多 64 字节。

数据库最终会变成文件系统里的文件，而数据库名就是相应的文件名，这就是数据库名有这么多限制的原因。

### 3.2 特殊的数据库名

有一些数据库名是保留的，可以直接访问这些有特殊语义的数据库：

#### 3.2.1 admin

相当于 `root` 数据库。如果将一个用户添加到 `admin` 数据库，那么它将获得所有数据库的权限。

一些特定的服务端命令只能从 `admin` 数据库运行，如列出所有数据库或关闭服务器。

#### 3.2.2 local

这个数据库永远都不可以复制，且一台服务器上所有的本地集合都可以存储在该库中。

#### 3.2.3 config

`MongoDB` 用于分片时设置，保存分片信息。

### 3.3 命名空间

把数据库名添加到集合名前，得到集合的完全限定名，即**命名空间(namespace)**。

命名空间的长度不得超过 121 字节，且在实际使用中应小于 100 字节。