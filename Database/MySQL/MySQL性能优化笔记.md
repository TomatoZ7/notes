# MySQL 性能优化笔记

MySQL 性能优化包括：

1. 硬件升级
2. 系统配置
3. 表结构设计

从**成本**上来看由高到低，从**效率**上来看由低到高。

作为开发人员一般关注3、4点优化。

该笔记是针对单机的 MySQL 进行优化。

> 当数据量达到 1000W 时，MySQL 的优化已有点吃力，当数据量达到 3000W~5000W 时，就不能单机了，而是要考虑主从、读写分离。如果还不行，那么就要分库分表了。如果还是不行，就要上缓存，用 redis 等将数据缓存起来，缓存后还可以集群。

## 硬件升级

硬件升级包括：

+ CPU
+ 内存
+ 硬盘
+ 网络

## 系统配置（参数调优）

### 扩大 innodb_buffer_pool_size

buffer_pool 是存储引擎（如 innodb）的缓存对象。buffer_pool 后才是硬盘/文件数据。

尽可能扩大内存中的数据量，将数据保存在内存中，从内存中读取数据，可以提升 MySQL 的性能。

> 内存中的数据应该是怎样的数据？ 热数据。

修改 my.cnf
```cnf
innodb_buffer_pool_size = 750M  // 在只运行MySQL的服务器下，一般可以调至内存的 75% ~ 80%
```

### 数据预热

通过脚本将磁盘上的全部数据缓存到内存中。

### 降低磁盘写入次数

增大 redolog，减少落盘次数，增大 innodb_log_file_size，有 75% 和 90% 机制。

通用查询日志、慢查询日志可以不开，binlog 开。

写 redolog 策略，innodb_flush_log_at_trx_commit 设置为 0 或 2。

> 当 innodb_flush_log_at_trx_commit = 1 时，一旦发生 commit 或自动 commit，就会马上写入 redolog。

## 数据库表设计

做数据库表设计的时候考虑到的优化有以下几点：

### 设计中间表

一般用于统计分析功能，或者实时性不高的需求([OLTP、OLAP](https://www.zhihu.com/question/24110442/answer/851671343))。

### 设计冗余字段

为减少关联查询，创建合理的冗余字段。

### 拆表

对于字段太多的大表，考虑拆表。

对于表中经常不被使用的字段或者存储数据比较多的字段(大文本)(最好是单独一张表)。

### 优化主键

每张表建议都要有一个主键(主键索引)，而且主键类型最好是 int 类型，建议自增主键。

> 没有主键 MySQL 可以存数据，首先它会寻找唯一键当做索引，如果没有唯一键，会自己生成，这些都跟性能损耗挂钩。

### 优化字段

将表中的字段的宽度设得尽可能小，能用数值型尽量用数值型。

> 数值型有两个优势：1、小，占空间少；2、有序