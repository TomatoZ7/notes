# 短链接的设计与实现

## 1 长链接 & 短链接

`https://github.com/TomatoZ7/notes-of-tz` 这个地址一共 `39` 个字符，属于长链接（实际情况下可能会携带各种参数，会更长）。

`https://github.com/U12zi` 这个地址是上面长链接经过处理得到，一共 `24` 个字符，属于短链接。

## 2 为什么需要短链接

以发送营销短信为例，每一条短信的字符是有上限的。如果使用长链接，那么很容易超过单条短信字符数量上限，变成两条短信。不仅增加成本，而且用户体验很差。如果使用短链接，将减少链接部分文字，从而增加文本文字数量。

除了营销场景之外，还多应用于二维码。

## 3 短链接如何跳到长链接

假设用户收到营销短信，之后点击营销短信里面的短链接，是如何跳到长链接的？

![image](Images/short_link_1.jpg)

主要分为三步：

1. 客户端访问短链接地址，短链接服务器校验是否是自己颁发的地址；

2. 短链接服务器识别出是自己颁发的地址，302 重定向到长链接地址；

3. 客户端获取到长链接地址进行访问。

## 4 长链接如何生成短链接
 6 
可以通过哈希算法和进制升级得到想要的短链接。如 `Google` 的 `guava` 包有 `MurmurHash` 算法的实现。

### 4.1 62 进制和 64 进制

62 进制只包含数字+大小写字母，而 64 进制会含有 `/`，`+`，`.` 这样的字符串，不符合正常 URL 字符串。而且如果是 6 位 62 进制的话，能有 560 亿种组合，满足业务需求。

### 4.2 解决哈希冲突

我们都知道在使用哈希算法时有可能会出现冲突。所谓冲突就是不同的长链接地址哈希计算后会生成相同的短链接。当客户端告知服务器短链接时不知道应该访问哪个长链接。

#### 4.2.1 ID 生成器 + 维护映射关系表

我们维护一个 `ID` 自增生成器。它可以生成 1、2、3... 这样自增的整数 `ID`。同时用 MySQL 或其他数据库保存短链接和长链接的映射关系，短链接和长链接字段加上唯一索引。

1. 生成短链接前先查询对应的长链接是否在数据库中，如果存在，则直接返回映射的长链接；

2. 每次生成短链接时都从 `ID` 生成器里取一个 `ID` 值，将 `id` 转化为 62 进制，将得到的结果拼接到短链接域名后面，得到最终的短链接。

3. 将每次生成的短链接进行一次数据表查询；

4. 如果存在，则可以给长链接拼接上特定的字符再进行哈希，不过要注意返回给客户端时要去掉拼接上的字符串。